<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - Bookstore</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="search.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header class="header">
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search books, authors, genres..." value="">
                </div>
            </div>
            <div class="profile">
                <div class="notification-badge">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </div>
                <div class="profile-icon">
                    <img src="https://i.pravatar.cc/40" alt="Profile">
                </div>
            </div>
        </header>

        <section class="search-results-section">
            <div class="search-meta">
                <h2>Search Results for "Mark Twain"</h2>
                <p class="results-count">24 books found</p>
            </div>

            <div class="search-content">
                <aside class="filters-sidebar">
                    <div class="filter-group">
                        <h4>Filter by</h4>
                        <div class="filter-options">
                            <div class="filter-item">
                                <label>Category</label>
                                <select class="filter-select">
                                    <option>All Categories</option>
                                    <option>Fiction</option>
                                    <option>Biography</option>
                                    <option>Classics</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label>Rating</label>
                                <div class="rating-filter">
                                    <div class="stars">
                                        <span class="star filled"></span>
                                        <span class="star filled"></span>
                                        <span class="star filled"></span>
                                        <span class="star filled"></span>
                                        <span class="star"></span>
                                        <span class="rating-text">& Up</span>
                                    </div>
                                </div>
                            </div>
                            <div class="filter-item">
                                <label>Publication Year</label>
                                <div class="year-range">
                                    <input type="number" placeholder="Min" min="1900" max="2023">
                                    <span>-</span>
                                    <input type="number" placeholder="Max" min="1900" max="2023">
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="book-cover">
                            <img src="https://m.media-amazon.com/images/I/81QuEGw8VPL._AC_UF1000,1000_QL80_.jpg"
                                alt="Adventures of Huckleberry Finn">
                        </div>
                        <div class="book-info">
                            <h3>Adventures of Huckleberry Finn</h3>
                            <p class="author">Mark Twain</p>
                            <div class="result-meta">
                                <div class="rating">
                                    <div class="stars">
                                        <span class="star filled"></span>
                                        <span class="star filled"></span>
                                        <span class="star filled"></span>
                                        <span class="star filled"></span>
                                        <span class="star"></span>
                                    </div>
                                    <span class="rating-count">(1,234 ratings)</span>
                                </div>
                                <div class="book-details">
                                    <span class="genre">Classic Literature</span>
                                    <span class="year">1884</span>
                                    <span class="pages">366 pages</span>
                                </div>
                            </div>
                            <p class="description">A masterpiece of American literature following Huckleberry Finn's
                                journey down the Mississippi River, exploring themes of freedom and social conventions.
                            </p>
                        </div>
                    </div>

                    <!-- Repeat result cards as needed -->
                </div>
            </div>

            <div class="pagination">
                <button class="page-button active">1</button>
                <button class="page-button">2</button>
                <button class="page-button">3</button>
                <button class="page-button next">Next <i class="fas fa-chevron-right"></i></button>
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('query') || '';
            const page = urlParams.get('page') || 1;

            // Fetch and display results
            await loadSearchResults(query, page);

            // Initialize filters
            await initializeFilters();
        });

        async function loadSearchResults(query, page) {
            try {
                const response = await fetch(`/search?query=${encodeURIComponent(query)}&page=${page}`);
                const { results, total, totalPages } = await response.json();

                // Update search meta
                document.querySelector('h2').textContent = `Search Results for "${query}"`;
                document.querySelector('.results-count').textContent = `${total} books found`;

                // Populate results
                const resultsGrid = document.querySelector('.results-grid');
                resultsGrid.innerHTML = results.map(createResultCard).join('');

                // Update pagination
                updatePagination(totalPages, page);
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        function createResultCard(book) {
            return `
    <div class="result-card" onclick="window.location.href='/single-book.html?id=${book.id}'">
        <div class="book-cover">
            <img src="${book.cover_url || 'placeholder.jpg'}" alt="${book.title}">
        </div>
        <div class="book-info">
            <h3>${book.title}</h3>
            <p class="author">${book.author}</p>
            <div class="result-meta">
                <div class="rating">
                    <div class="stars">
                        ${'<span class="star filled"></span>'.repeat(Math.floor(book.rating || 0))}
                        ${'<span class="star"></span>'.repeat(5 - Math.floor(book.rating || 0))}
                    </div>
                </div>
                <div class="book-details">
                    <span class="genre">${book.category}</span>
                    <span class="year">${new Date(book.publication_date).getFullYear()}</span>
                    <span class="pages">${book.pages} pages</span>
                </div>
            </div>
            <p class="description">${book.description || ''}</p>
        </div>
    </div>`;
        }

        async function initializeFilters() {
            // Populate categories
            const categorySelect = document.querySelector('.filter-select');
            const categories = await fetch('/categories').then(r => r.json());
            categorySelect.innerHTML = `
        <option>All Categories</option>
        ${categories.map(c => `<option>${c}</option>`).join('')}
    `;

            // Add filter event listeners
            document.querySelectorAll('.filter-select, .year-range input').forEach(element => {
                element.addEventListener('change', applyFilters);
            });
        }

        function applyFilters() {
            const url = new URL(window.location);
            url.searchParams.set('category', document.querySelector('.filter-select').value);
            url.searchParams.set('minYear', document.querySelector('.year-range input[placeholder="Min"]').value);
            url.searchParams.set('maxYear', document.querySelector('.year-range input[placeholder="Max"]').value);
            window.location = url.toString();
        }

        function updatePagination(totalPages, currentPage) {
            const pagination = document.querySelector('.pagination');
            pagination.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                pagination.innerHTML += `
            <button class="page-button ${i == currentPage ? 'active' : ''}" 
                    onclick="navigateToPage(${i})">${i}</button>
        `;
            }

            if (currentPage < totalPages) {
                pagination.innerHTML += `
            <button class="page-button next" 
                    onclick="navigateToPage(${parseInt(currentPage) + 1})">
                Next <i class="fas fa-chevron-right"></i>
            </button>`;
            }
        }

        function navigateToPage(page) {
            const url = new URL(window.location);
            url.searchParams.set('page', page);
            window.location = url.toString();
        }
    </script>
</body>

</html>